!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e||self).pegasysHelpers={})}(this,function(e){var t=/*#__PURE__*/function(){function e(){}return e.prototype.createQuestion=function(e,t){return{id:e,description:t}},e}();function n(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function r(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(r)return(r=r.call(e)).next.bind(r);if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return n(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?n(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var o=0;return function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function o(){return o=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)({}).hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},o.apply(null,arguments)}function i(e,t){try{var n=e()}catch(e){return t(e)}return n&&n.then?n.then(void 0,t):n}var s="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function u(e,t,n){if(!e.s){if(n instanceof c){if(!n.s)return void(n.o=u.bind(null,e,t));1&t&&(t=n.s),n=n.v}if(n&&n.then)return void n.then(u.bind(null,e,t),u.bind(null,e,2));e.s=t,e.v=n;var r=e.o;r&&r(e)}}var a,c=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,n){var r=new e,o=this.s;if(o){var i=1&o?t:n;if(i){try{u(r,1,i(this.v))}catch(e){u(r,2,e)}return r}return this}return this.o=function(e){try{var o=e.v;1&e.s?u(r,1,t?t(o):o):n?u(r,1,n(o)):u(r,2,o)}catch(e){u(r,2,e)}},r},e}();function l(e){return e instanceof c&&1&e.s}function f(e,t,n){var r,o,i=-1;return function s(a){try{for(;++i<e.length&&(!n||!n());)if((a=t(i))&&a.then){if(!l(a))return void a.then(s,o||(o=u.bind(null,r=new c,2)));a=a.v}r?u(r,1,a):r=a}catch(e){u(r||(r=new c),2,e)}}(),r}function h(e,t,n){if("function"==typeof e[s]){var r,o,i,a=function(e){try{for(;!((r=h.next()).done||n&&n());)if((e=t(r.value))&&e.then){if(!l(e))return void e.then(a,i||(i=u.bind(null,o=new c,2)));e=e.v}o?u(o,1,e):o=e}catch(e){u(o||(o=new c),2,e)}},h=e[s]();if(a(),h.return){var v=function(e){try{r.done||h.return()}catch(e){}return e};if(o&&o.then)return o.then(v,function(e){throw v(e)});v()}return o}if(!("length"in e))throw new TypeError("Object is not iterable");for(var m=[],d=0;d<e.length;d++)m.push(e[d]);return f(m,function(e){return t(m[e])},n)}e.LOG_LEVELS=void 0,(a=e.LOG_LEVELS||(e.LOG_LEVELS={}))[a.NONE=0]="NONE",a[a.ERROR=1]="ERROR",a[a.WARN=2]="WARN",a[a.INFO=3]="INFO",a[a.DEBUG=4]="DEBUG",e.DTFunctions=/*#__PURE__*/function(){function t(t){void 0===t&&(t=e.LOG_LEVELS.ERROR),this.currentLogLevel=void 0,this.jsonSizeThreshold=2e4,this.currentLogLevel=t}var n=t.prototype;return n.setLogLevel=function(e){this.currentLogLevel=e},n.performGradingPlatform=function(e){var t=e.oauth_client_id,n=e.oauth_client_secret,r=e.dt_account_urn,o=e.oauth_sso_endpoint,i=e.dt_platform_environment,s=e.documentType,u=e.documentName,a=e.validationId,c=e.maxScore,l=e.getScore;try{var f=this,h=null;return Promise.resolve(f.getOauthAccessToken(t,n,r,o)).then(function(e){if(!e)throw new Error("Failed to obtain access token");return Promise.resolve(f.getAuthorizationHeaderPlatform(e)).then(function(e){return h=e,Promise.resolve(f.getDocumentsList(i,s,u,h)).then(function(e){return Promise.resolve(f.getDocumentDetails(i,e,h)).then(function(t){return Promise.resolve(f.generateAuditInfo({documentList:e,documentDetails:t})).then(function(e){return Promise.resolve(l(e,h)).then(function(t){var n=t.score;return e.assertionFails=t.assertion_fails,{validationId:a,maxScore:c,finalScore:n,auditInfo:e}})})})})})})}catch(e){return Promise.reject(e)}},n.performGradingGen2=function(e){var t=e.dt_gen2_environment,n=e.dt_access_token,r=e.validationId,o=e.maxScore,i=e.entity_type,s=e.entity_name_to_query,u=e.config_endpoint,a=e.config_name_to_query,c=e.config_endpoint_extra_param,l=e.settings_schema_id,f=e.settings_scope,h=e.getScore;try{var v=this;return Promise.resolve(v.getAuthorizationHeaderGen2(n)).then(function(e){return Promise.resolve(v.getEntities(t,i,s,e)).then(function(n){return Promise.resolve(v.getEntitiesData(t,n,e)).then(function(i){return Promise.resolve(v.getConfigsList(t,u,a,c,n,e)).then(function(s){return Promise.resolve(v.getConfigsData(t,u,s,e)).then(function(u){return Promise.resolve(v.getSettingsData(t,n,e,l,f)).then(function(a){return Promise.resolve(v.getProblemsData(t,n,e)).then(function(c){return Promise.resolve(v.getClassicDashboardList(t,e)).then(function(l){return Promise.resolve(v.getDashboardsData(t,l,e)).then(function(t){return Promise.resolve(v.generateAuditInfo({entitiesList:n,entitiesData:i,settingsData:a,configList:s,configDetails:u,problemsData:c,classicDashboardList:l,classicDashboardDetails:t})).then(function(t){return Promise.resolve(h(t,e)).then(function(e){var n=e.score;return t.assertionFails=e.assertion_fails,{validationId:r,maxScore:o,finalScore:n,auditInfo:t}})})})})})})})})})})})}catch(e){return Promise.reject(e)}},n.getOauthAccessToken=function(t,n,r,o){try{var s=this,u=new Headers;u.append("Content-Type","application/x-www-form-urlencoded");var a=new URLSearchParams;a.append("grant_type","client_credentials"),a.append("client_id",t),a.append("client_secret",n),a.append("scope","document:documents:admin document:documents:read document:documents:write document:environment-shares:read document:direct-shares:read "),a.append("resource",r);var c={method:"POST",headers:u,body:a,redirect:"follow"};return Promise.resolve(i(function(){return Promise.resolve(fetch(o,c)).then(function(t){function n(n){return Promise.resolve(t.json()).then(function(t){return s.log(e.LOG_LEVELS.DEBUG,"oAuth Access Token result:\n"+JSON.stringify(t,null,2)),t.access_token})}var r=function(){if(!t.ok)return 400===t.status?Promise.resolve(t.text()).then(function(n){throw s.log(e.LOG_LEVELS.ERROR,"oAuth Access Token Error: "+t.status+" "+n),new Error("Bad Request: "+n)}):Promise.resolve(t.text()).then(function(n){throw s.log(e.LOG_LEVELS.ERROR,"oAuth Access Token Error: "+t.status+" "+n),new Error("HTTP error! status: "+t.status)})}();return r&&r.then?r.then(n):n()})},function(t){s.log(e.LOG_LEVELS.ERROR,"oAuth Access Token Error: "+t.message)}))}catch(e){return Promise.reject(e)}},n.getAuthorizationHeaderPlatform=function(e){try{var t=new Headers;return t.append("Authorization","Bearer "+e),Promise.resolve(t)}catch(e){return Promise.reject(e)}},n.getAuthorizationHeaderGen2=function(e){try{var t=new Headers;return t.append("Authorization","Api-Token "+e),Promise.resolve(t)}catch(e){return Promise.reject(e)}},n.getEntities=function(t,n,r,o){try{var s=this,u=new Request(t+"/api/v2/entities?entitySelector=type("+n+"),entityName.contains("+r+")",{method:"GET",headers:o}),a=null,c=i(function(){return Promise.resolve(fetch(u)).then(function(t){var n=t.ok?Promise.resolve(t.json()).then(function(e){a=e}):Promise.resolve(t.text()).then(function(n){s.log(e.LOG_LEVELS.ERROR,'"Entity ID Error: '+t.status+" "+n)});if(n&&n.then)return n.then(function(){})})},function(t){s.log(e.LOG_LEVELS.ERROR," "+t)});return Promise.resolve(c&&c.then?c.then(function(){return a}):a)}catch(e){return Promise.reject(e)}},n.getEntitiesData=function(t,n,r){try{var o=this;if(null===n)return Promise.resolve([]);var s=[],u=h(n.entities,function(n){var u=new Request(t+"/api/v2/entities/"+n.entityId,{method:"GET",headers:r}),a=i(function(){return Promise.resolve(fetch(u)).then(function(t){var n=t.ok?Promise.resolve(t.json()).then(function(e){s.push(e)}):Promise.resolve(t.text()).then(function(n){o.log(e.LOG_LEVELS.ERROR,"Entity Details Error: "+t.status+" "+n)});if(n&&n.then)return n.then(function(){})})},function(t){o.log(e.LOG_LEVELS.ERROR," "+t)});if(a&&a.then)return a.then(function(){})});return Promise.resolve(u&&u.then?u.then(function(){return s}):s)}catch(e){return Promise.reject(e)}},n.getClassicDashboardList=function(t,n){try{var r=this,o=[],s=[],u=i(function(){return Promise.resolve(r.getConfigsList(t,"/api/config/v1/dashboards","","",null,n)).then(function(t){o=t,r.log(e.LOG_LEVELS.DEBUG,"dashboard_list raw:\n"+JSON.stringify(o[0].dashboards,null,2));var n=o[0].dashboards.filter(function(e){return"Dynatrace"!==e.owner});n.length>0&&s.push({dashboards:n}),r.log(e.LOG_LEVELS.DEBUG,"user_dashboard_list:\n"+JSON.stringify(s[0].dashboards,null,2))})},function(t){r.log(e.LOG_LEVELS.ERROR,"getClassicDashboardList Error: "+t)});return Promise.resolve(u&&u.then?u.then(function(){return s}):s)}catch(e){return Promise.reject(e)}},n.getDashboardsData=function(t,n,r){try{var o=this;if(null===n)return Promise.resolve([]);var s=[],u=i(function(){return Promise.resolve(o.getConfigsData(t,"/api/config/v1/dashboards",n,r)).then(function(t){s=t,o.log(e.LOG_LEVELS.DEBUG,"dashboardsData:\n"+JSON.stringify(s,null,2))})},function(t){o.log(e.LOG_LEVELS.ERROR,"getDashboardsData Error: "+t)});return Promise.resolve(u&&u.then?u.then(function(){return s}):s)}catch(e){return Promise.reject(e)}},n.getConfigsList=function(t,n,r,i,s,u){try{var a=this,c=[];if(""===n)return Promise.resolve([]);var l="";a.log(e.LOG_LEVELS.DEBUG,"entitieslist in config_list:\n"+JSON.stringify(s,null,2)),a.log(e.LOG_LEVELS.DEBUG,"config_endpoint_extra_param:"+i);var f=function(){if(i.includes("/")&&s){var f=function(){a.log(e.LOG_LEVELS.DEBUG,"config_list:\n"+JSON.stringify(c,null,2))};a.log(e.LOG_LEVELS.DEBUG,"Config List with extra param /");var v=h(s.entities,function(e){return l="/"+e.entityId+i,Promise.resolve(a.callConfigList(t,n,r,l,u)).then(function(e){c.push(e)})});return v&&v.then?v.then(f):f()}var m=i.includes("?")?(a.log(e.LOG_LEVELS.DEBUG,"Config List with extra param ?"),l=i,Promise.resolve(a.callConfigList(t,n,r,l,u)).then(function(e){c.push(e)})):(a.log(e.LOG_LEVELS.DEBUG,"Config List with no param"),Promise.resolve(a.callConfigList(t,n,r,l,u)).then(function(t){c.push(t),a.log(e.LOG_LEVELS.DEBUG,"config_list before:\n"+JSON.stringify(c,null,2)),""!=r&&(c=c.map(function(e){return o({},e,{values:e.values.filter(function(e){return e.name.toLowerCase().includes(r.toLowerCase())})})}).filter(function(e){return e.values.length>0})),a.log(e.LOG_LEVELS.DEBUG,"config_list after:\n"+JSON.stringify(c,null,2))}));if(m&&m.then)return m.then(function(){})}();return Promise.resolve(f&&f.then?f.then(function(){return c}):c)}catch(e){return Promise.reject(e)}},n.callConfigList=function(t,n,r,o,s){try{var u=this,a=new Request(t+n+o,{method:"GET",headers:s}),c=[],l=i(function(){return Promise.resolve(fetch(a)).then(function(t){var n=t.ok?Promise.resolve(t.json()).then(function(e){c=e}):Promise.resolve(t.text()).then(function(n){u.log(e.LOG_LEVELS.ERROR,"ConfigList Error: "+t.status+" "+n)});if(n&&n.then)return n.then(function(){})})},function(t){u.log(e.LOG_LEVELS.ERROR,""+t)});return Promise.resolve(l&&l.then?l.then(function(){return c}):c)}catch(e){return Promise.reject(e)}},n.getConfigsData=function(t,n,r,o){try{var s=this;if(null===r)return Promise.resolve([]);var u=[],a=h(r,function(r){return function(a){var c=[];for(var l in a)c.push(l);return f(c,function(a){return function(a){return function(){if(a&&null!=a&&Array.isArray(r[a]))return h(r[a],function(r){var a=r?r.entityId||r.id:null,c=function(){if(a){var r=new Request(t+n+"/"+a,{method:"GET",headers:o}),c=i(function(){return Promise.resolve(fetch(r)).then(function(t){var n=t.ok?Promise.resolve(t.json()).then(function(e){u.push(e)}):Promise.resolve(t.text()).then(function(n){s.log(e.LOG_LEVELS.ERROR,"Config Data Error: "+t.status+" "+n)});if(n&&n.then)return n.then(function(){})})},function(t){s.log(e.LOG_LEVELS.ERROR,""+t)});if(c&&c.then)return c.then(function(){})}}();if(c&&c.then)return c.then(function(){})})}()}(c[a])},void 0)}(r)});return Promise.resolve(a&&a.then?a.then(function(){return u}):u)}catch(e){return Promise.reject(e)}},n.getSettingsData=function(t,n,o,s,u){try{var a=this,c=[];if(""===s)return Promise.resolve([]);var l="";if("entity"===u)for(var f,h=r(n.entities);!(f=h()).done;)l=l+f.value.entityId+",";else l=u;if(""==l)return Promise.resolve([]);var v=new Request(t+"/api/v2/settings/objects?schemaIds="+s+"&scopes="+l,{method:"GET",headers:o}),m=i(function(){return Promise.resolve(fetch(v)).then(function(t){var n=t.ok?Promise.resolve(t.json()).then(function(e){c.push(e)}):Promise.resolve(t.text()).then(function(n){a.log(e.LOG_LEVELS.ERROR,"Settings Data Error: "+t.status+" "+n)});if(n&&n.then)return n.then(function(){})})},function(t){a.log(e.LOG_LEVELS.ERROR,""+t)});return Promise.resolve(m&&m.then?m.then(function(){return c}):c)}catch(e){return Promise.reject(e)}},n.getProblemsData=function(t,n,o){try{var s=this;if(!n||!n.entities||n.entities.length<=0)return Promise.resolve(null);for(var u,a="",c=r(n.entities);!(u=c()).done;)a+=","+u.value.entityId;a=a.substring(1);var l=new Request(t+"/api/v2/problems?from=now-6h&problemSelector=rootCauseEntity("+a+")",{method:"GET",headers:o}),f=null,h=i(function(){return Promise.resolve(fetch(l)).then(function(t){var n=t.ok?Promise.resolve(t.json()).then(function(e){f=e}):Promise.resolve(t.text()).then(function(n){s.log(e.LOG_LEVELS.ERROR,"Problems Data Error: "+t.status+" "+n)});if(n&&n.then)return n.then(function(){})})},function(t){s.log(e.LOG_LEVELS.ERROR,""+t)});return Promise.resolve(h&&h.then?h.then(function(){return f}):f)}catch(e){return Promise.reject(e)}},n.getDocumentsList=function(t,n,r,o){try{var s=this,u="name contains '"+r+"' and type == '"+n+"'",a=new Request(t+"/platform/document/v1/documents?admin-access=true&filter="+encodeURIComponent(u),{method:"GET",headers:o});s.log(e.LOG_LEVELS.DEBUG,"documentFilter:\n"+JSON.stringify(u,null,2));var c=null,l=i(function(){return s.log(e.LOG_LEVELS.DEBUG,"headers:\n"+JSON.stringify(o,null,2)),Promise.resolve(fetch(a)).then(function(t){s.log(e.LOG_LEVELS.DEBUG,"response:\n"+JSON.stringify(t,null,2));var n=t.ok?Promise.resolve(t.json()).then(function(e){c=e}):Promise.resolve(t.text()).then(function(n){s.log(e.LOG_LEVELS.ERROR,"Document List Error: "+t.status+" "+n)});if(n&&n.then)return n.then(function(){})})},function(t){s.log(e.LOG_LEVELS.ERROR,""+t)});return Promise.resolve(l&&l.then?l.then(function(){return c}):c)}catch(e){return Promise.reject(e)}},n.getDocumentDetails=function(t,n,r){try{var o=function(){var t=JSON.stringify(u),n=new Blob([t]).size;return s.log(e.LOG_LEVELS.DEBUG,"jsonSize:"+n),n>s.jsonSizeThreshold&&(s.log(e.LOG_LEVELS.DEBUG,"jsonSize exceed "+s.jsonSizeThreshold),u=[{warning:"The size of the JSON output is too large"}]),s.log(e.LOG_LEVELS.DEBUG,"documentDetails:\n"+JSON.stringify(u,null,2)),u},s=this;if(null===n)return Promise.resolve([]);var u=[],a={method:"GET",headers:r},c=h(n.documents,function(n){var r=String(n.id),o=i(function(){return Promise.resolve(fetch(t+"/platform/document/v1/documents/"+r+"/content?admin-access=true",a)).then(function(n){var o=n.ok?Promise.resolve(n.json()).then(function(n){var o="documentId=='"+r+"'";return Promise.resolve(fetch(t+"/platform/document/v1/direct-shares?filter="+encodeURIComponent(o),a)).then(function(r){function i(){return Promise.resolve(fetch(t+"/platform/document/v1/environment-shares?filter="+encodeURIComponent(o),a)).then(function(t){function r(){n.sections&&n.sections.forEach(function(e){e.state&&(e.state.result&&delete e.state.result,e.state.davis&&e.state.davis.resultState&&delete e.state.davis.resultState)}),u.push(n)}var o=t.ok?Promise.resolve(t.json()).then(function(t){s.log(e.LOG_LEVELS.DEBUG,"environmentSharesResult:\n"+JSON.stringify(t,null,2)),n["environment-shares"]=t["environment-shares"]}):Promise.resolve(t.text()).then(function(n){s.log(e.LOG_LEVELS.ERROR,"Environment Shares Error: "+t.status+" "+n)});return o&&o.then?o.then(r):r()})}var c=r.ok?Promise.resolve(r.json()).then(function(t){s.log(e.LOG_LEVELS.DEBUG,"directSharesResult:\n"+JSON.stringify(t,null,2)),n["direct-shares"]=t["direct-shares"]}):Promise.resolve(r.text()).then(function(t){s.log(e.LOG_LEVELS.ERROR,"Direct Shares Error: "+r.status+" "+t)});return c&&c.then?c.then(i):i()})}):Promise.resolve(n.text()).then(function(t){s.log(e.LOG_LEVELS.ERROR,"Document Details Error: "+n.status+" "+t)});if(o&&o.then)return o.then(function(){})})},function(t){s.log(e.LOG_LEVELS.ERROR,""+t)});if(o&&o.then)return o.then(function(){})});return Promise.resolve(c&&c.then?c.then(o):o())}catch(e){return Promise.reject(e)}},n.generateAuditInfo=function(e){var t=e.documentList,n=e.documentDetails,r=e.entitiesList,o=e.entitiesData,i=e.settingsData,s=e.configList,u=e.configDetails,a=e.problemsData,c=e.classicDashboardList,l=e.classicDashboardDetails;try{var f={};return null!=t&&(f.documentList=t),null!=n&&(f.documentDetails=n),null!=r&&(f.entitiesList=r),null!=o&&(f.entitiesData=o),null!=s&&(f.configList=s),null!=u&&null==u.error&&(f.configDetails=u),null!=i&&(f.settingsData=i),null!=a&&(f.problemsData=a),null!=c&&(f.classicDashboardList=c),null!=l&&(f.classicDashboardDetails=l),f.assertionFails=[],Promise.resolve(f)}catch(e){return Promise.reject(e)}},n.checkKeywordsExistence=function(e,t){var n=e.replace(/\s+/g,"").toLowerCase();return t.map(function(e){return e.replace(/\s+/g,"").toLowerCase()}).every(function(e){return n.includes(e)})},n.findIdInObject=function(e){for(var t in e)if(e.hasOwnProperty(t))if("object"==typeof e[t]){var n=this.findIdInObject(e[t]);if(n)return n}else if("id"===t||"entityId"===t)return e[t];return null},n.log=function(e,t){e<=this.currentLogLevel&&console.log(t)},t}(),e.QuestionSDK=t});
//# sourceMappingURL=index.umd.js.map
